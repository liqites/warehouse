<style>
    .table > thead > tr > th, .table > tbody > tr > td {
        text-align: center;
    }
</style>

<div class="panel panel-warning">
  <div class="panel-heading" style="display: flex;">
    <h3>差异报表</h3>
    <h5 style="margin-top: 25px;margin-left: 20px;">导入报表,选择报表所属位置,时间范围,系统根据报表自动计算差异,可以选择在网页或者直接导出xlsx格式的文档进行查看</h5>
  </div>
  <div class="panel-body">
    <script type="text/javascript">
        $(function () {
            data_upload("#item-data-uploader", false, function (data) {
                if (data.result) {
                    $("#file").val(JSON.stringify(data.content));
                    $("#item-data-uploader-preview > span[info]").html("文件上传成功");
                } else {
                    $("#file").val('');
                }
            });
        });
        function submitForm() {
            if ($("#file").val().length > 0)
                document.forms[0].submit();
            else
                alert('请上传文件');
        }
    </script>
    <% if current_user.can_edit_inventory? %>
        <% if current_user.permission?(:operate_report_upload) %>
            <div style="display: flex;">
              <span style="margin-top: 5px;">上传报表：</span>
              <input id="item-data-uploader" type="file" name="files[]" data-url="/reports/upload_file">

              <div class="abstractblock" id="item-data-uploader-preview" style="<%= "display:none" if @file.nil? %>;">
                <% if @file %>
                    <span>文件：<%= @file["data"]["original_filename"] %></span>
                    <br>
                    <span info>文件上传成功</span>
                <% end %>
              </div>
            </div>
        <% end %>
    <% end %>

    <form method="get" action="<%= reports_discrepancy_path %>">
      <div class="col-sm-12" style="border-bottom: 1px dashed #000;height: 40px; border-top: 1px solid #000;margin-top: 5px;padding-top: 5px;">
        <div class="col-sm-4">
          <span class="label label-info">报表类型:</span>
          <%= select_tag(:type, options_for_select(ReportType.list, @type), include_blank: false, :style => 'min-width:150px;') %>
        </div>
        <div class="col-sm-4">
          <span class="label label-info">地点:</span>
          <%= select_tag(:location_id, options_for_select(Location.all.collect { |l| [l.name, l.id] }, @location_id), include_blank: false) %>
        </div>
        <div class="col-sm-4">
          <span class="label label-info">显示方式:</span>
          <%= select_tag :format, options_for_select([["Web", "html"], ["Excel File(MS 07 or later)", "xlsx"]], "html") %>
        </div>
      </div>

      <div class="col-sm-12" style="margin-top: 15px;margin-bottom: -5px;">
        <div class="col-sm-6">
          <span class="label label-info">时间范围:</span>
          <input type="text" name="received_date_start" class="datepicker" value="<%= @date_start %>"/>
          ~ <input type="text" name="received_date_end" class="datepicker" value="<%= @date_end %>"/>
        </div>
        <div class="col-sm-2">
          <input type="hidden" id="file" name="file" value="<%= @jsonfile %>">
        </div>

        <div class="col-sm-4">
          <input type="button" style="width: 150px;" value="确定" class="btn btn-warning" name="commit" onclick="submitForm()"/>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="alert alert-success" role="alert" style="margin-top: -20px;">
  <p><%= @title %></p>
</div>


<table class="table table-striped table-bordered table-hover" style="margin-top: -20px;">
  <thead>
  <tr>
    <th>编号</th>
    <th>零件号</th>
    <th>部门</th>
    <th>报表数量</th>
    <th>系统数量</th>
    <th>差异值</th>
  </tr>
  </thead>
  <tbody>
  <% i = 0 %>
  <% @results.each do |key, value| %>
      <tr>
        <td><%= i+1 %>
          <% i=i+1 %></td>
        <td><span class="label label-info"><%= value["PartNr."] %></span></td>
        <td><%= value["Warehouse"] %></td>
        <td><span class="badge"><%= value["Amount"] %></span></td>
        <td><span class="badge"><%= @packages[key].nil? ? 0 : @packages[key]["Amount"] %></span></td>
        <td>
          <% d = @packages[key].nil? ? value["Amount"] : value["Amount"] - @packages[key]["Amount"] %>
          <% if d > 0 %>
              <span class="label label-danger"><%= d %></span>
          <% elsif d < 0 %>
              <span class="label label-warning"><%= d %></span>
          <% else %>
              <span class="label label-primary"><%= d %></span>
          <% end %>
        </td>
      </tr>
  <% end %>
  </tbody>
</table>

<script>
    $(function () {
        $(".datepicker").datetimepicker({
            lang: 'ch',
            format: 'Y-m-d H:i'
        });
    });
    init_check();
</script>
