<style>
    .CheckBoxName {
        cursor: pointer;
        margin: 0 0 0 10px;
    }

    .ShowPermissionTips {
        border-radius: 4px;
        background: steelblue;
        display: none;
        min-height: 40px;
        color: white;
        padding: 2px 0 0 0;
        text-align: center;
    }

    .ShowPermissionTipsCaret {
        border-bottom: 6px solid steelblue;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        display: none;
        height: 0;
        margin: -5px 0 0 20px;
        width: 0;
    }

    .SavePermissionGroups {
        width: 200px;
        height: 50px;
        margin: 5px 0 0 0;
        font-size: 1.2em;
    }

    a:hover {
        background-color: white;
    }
</style>

<div class="panel panel-primary" style="margin: 20px 15px 0 15px;">
  <div class="panel-body" style="text-align: center;padding: 20px 0 5px 0">
    <div class="col-md-3">
      <strong>员工号:</strong>
      <strong style="overflow: hidden;text-overflow: ellipsis;" title="<%= @user.id %>">
        <%= @user.id %></strong>
    </div>
    <div class="col-md-2">
      <strong>姓名:</strong>
      <strong><%= @user.name %></strong>
    </div>
    <div class="col-md-2">
      <strong>所属地点:</strong>
      <strong><%= @user.location.name %></strong>
    </div>
    <div class="col-md-3">
      <strong>角色:</strong>
      <strong><%= @user.role %></strong>
    </div>
    <a href="/users">
      <button class="btn btn-success" style="width: 200px;margin: -10px 0 5px 46px;">
        <i class="glyphicon glyphicon-share-alt" style="transform: rotate(200deg)"></i>&emsp;返回
      </button>
    </a>
  </div>
</div>

<div class="col-md-12" style="margin: 20px 0 0 0;">
  <div class="panel panel-info">
    <div class="panel-heading">
      <div class="panel-title" style="display: flex;">
        <div class="col-md-3">
          <h3>分配权限组</h3>
        </div>
        <div class="col-md-9" style="text-align: right;">
          <button class="btn btn-primary SavePermissionGroups"><i class="glyphicon glyphicon-ok"></i>&emsp;保存</button>
        </div>
      </div>
    </div>
    <div class="panel-body" style="text-align: center;border-bottom: 1px solid #000000;">
      <div class="col-md-2">
        <h4>已拥有权限组</h4>
      </div>

      <div class="col-md-9 HasPermissionGroups" style="border-left: 1px solid #CCCCCC;min-height: 60px;">
      </div>
    </div>

    <div class="panel-body" style="text-align: center;">
      <div class="col-md-2">
        <h4>未拥有权限组</h4>
      </div>

      <div class="col-md-9 NoPermissionGroups" style="border-left: 1px solid #CCCCCC;min-height: 60px;">
      </div>
    </div>
  </div>
</div>

<script type="text/javascript" charset="utf-8">
    var ClientHeight = document.documentElement.clientHeight;
    $('.HasPermissionGroups').css({height: (ClientHeight - 450) / 2 + 'px'});
    $('.NoPermissionGroups').css({height: (ClientHeight - 450) / 2 + 'px'});

    <% @permission_groups.each_with_index do |p| %>
    if (<%= p[:status] %>) {
        $('<div class="col-md-1" style="white-space: nowrap;text-overflow: ellipsis;overflow: hidden;font-size: 1.2em;">' +
                '<input type="checkbox" class="CheckBox" id="<%= p[:id]%>" ischecked="true" checked><strong class="CheckBoxName" title="<%= p[:name] %>">' + '<%= p[:name] %>' + '</strong></input></div>').appendTo('.HasPermissionGroups').ready(function () {
        });
    } else {
        $('<div class="col-md-1" style="white-space: nowrap;text-overflow: ellipsis;overflow: hidden;font-size: 1.2em;">' +
                '<input type="checkbox" class="CheckBox" id="<%= p[:id]%>" ischecked="false"> <strong class="CheckBoxName" title="<%= p[:name] %>">' + '<%= p[:name] %>' + '</strong></input></div>').appendTo('.NoPermissionGroups').ready(function () {
        });
    }
    <% end %>

    $(".CheckBox").click(function () {
        if ($(this).attr('ischecked') == "true") {
            $(this).attr('ischecked', 'false');
        } else {
            $(this).attr('ischecked', 'true');
        }
    });

    $('.CheckBoxName').unbind().on('click', function (event) {
        var e = window.event || event;
        if (e.stopPropagation) {
            e.stopPropagation();
        } else {
            e.cancelBubble = true;
        }
        var PermissionGroupsID = $(this).parent().children('input').attr('id');
        var PermissionGroupsName = $(this).html();
        var PermissionGroupsStatus = $(this).parent().children('input').attr('ischecked');

        $('.ShowPermissionTipsCaret').remove();
        $('.ShowPermissionTips').remove();

        $.ajax({
            url: '/permission_groups/permission_details',
            type: 'get',
            data: {
                permission_groups_id: PermissionGroupsID
            },
            success: function (data) {
                console.log(data);
                if (data == "") {
                    $('<div class="ShowPermissionTipsCaret"></div>' +
                            '<div class="ShowPermissionTips" style="padding: 10px 0 0 10px;"> Nothing </div>').appendTo($('#' + PermissionGroupsID).parent()).ready(function () {
                    });
                    $('.ShowPermissionTipsCaret').fadeIn(400);
                    $('.ShowPermissionTips').fadeIn(400);
                } else {
                    $('<div class="ShowPermissionTipsCaret"></div>' +
                            '<div class="ShowPermissionTips"></div>').appendTo($('#' + PermissionGroupsID).parent()).ready(function () {
                    });
                    $('.ShowPermissionTipsCaret').fadeIn(400);
                    $('.ShowPermissionTips').fadeIn(400);

                    for (var i = 0; i < data.length; i++) {
                        $('.ShowPermissionTips').append('<span style="overflow: hidden;text-overflow: ellipsis;cursor: pointer;padding:0 0 2px 2px;" title="' + data[i] + '">' + data[i] + '</span> <hr style="margin: 0;"/ > ');
                    }
                }
            },
            error: function () {
                console.log("请求数据错误.无法链接到服务器.");
            },
            complete: function (xhr) {
                if (xhr.status == 304) return;
            }
        });
    });

    document.onclick = function () {
        $('.ShowPermissionTipsCaret').remove();
        $('.ShowPermissionTips').remove();
    };

    var PermissionGroupsJSON = [];
    $('.SavePermissionGroups').unbind().on('click', function () {
        $('.CheckBox').each(function () {
            var PerssionGroupsID = $(this).attr('id');
            var PerssionGroupsName = $(this).parent().children('strong').html();
            var PerssionGroupsStatus = $(this).attr('ischecked');
            PermissionGroupsJSON.push({id: PerssionGroupsID, name: PerssionGroupsName, status: PerssionGroupsStatus});
        });

        $.ajax({
            url: '/users/permission_groups',
            type: 'post',
            data: {
                user_id: '<%=@user.id %>',
                permission_groups_data: PermissionGroupsJSON
            },
            success: function (data) {
                location.reload();
            },
            error: function () {
            },
            complete: function (xhr) {
                if (xhr.status == 304) return;
            }
        });
    })
</script>